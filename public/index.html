<!DOCTYPE html>
<html>
<head>
    <style type=text/css>
        body {
            background-color: rgb(0, 255, 0);
        }

        .chat {
            color: rgb(255, 255, 255);
            font-weight: 900;
            font-size: 10vh;
            font-family: "Segoe UI Emoji", "MS P ゴシック";
            position: absolute;
            animation: commentMove 10s linear;

            /* これによってコメントが長くても折り返さないようになる */
            white-space: nowrap;

            text-shadow: rgb(0, 0, 0) 4px 0px 0px, rgb(0, 0, 0) 3.87565px 0.989616px 0px, rgb(0, 0, 0) 3.51033px 1.9177px 0px, rgb(0, 0, 0) 2.92676px 2.72656px 0px, rgb(0, 0, 0) 2.16121px 3.36588px 0px, rgb(0, 0, 0) 1.26129px 3.79594px 0px, rgb(0, 0, 0) 0.282949px 3.98998px 0px, rgb(0, 0, 0) -0.712984px 3.93594px 0px, rgb(0, 0, 0) -1.66459px 3.63719px 0px, rgb(0, 0, 0) -2.51269px 3.11229px 0px, rgb(0, 0, 0) -3.20457px 2.39389px 0px, rgb(0, 0, 0) -3.69721px 1.52664px 0px, rgb(0, 0, 0) -3.95997px 0.56448px 0px, rgb(0, 0, 0) -3.97652px -0.432781px 0px, rgb(0, 0, 0) -3.74583px -1.40313px 0px, rgb(0, 0, 0) -3.28224px -2.28625px 0px, rgb(0, 0, 0) -2.61457px -3.02721px 0px, rgb(0, 0, 0) -1.78435px -3.57996px 0px, rgb(0, 0, 0) -0.843183px -3.91012px 0px, rgb(0, 0, 0) 0.150409px -3.99717px 0px, rgb(0, 0, 0) 1.13465px -3.8357px 0px, rgb(0, 0, 0) 2.04834px -3.43574px 0px, rgb(0, 0, 0) 2.83468px -2.82216px 0px, rgb(0, 0, 0) 3.44477px -2.03312px 0px, rgb(0, 0, 0) 3.84068px -1.11766px 0px, rgb(0, 0, 0) 3.9978px -0.132717px 0px;
        }

        @keyframes commentMove {
            0% {
                margin-left: 100%;
                transform: translateX(100%);
            }
            /* 100%まで行くと左端に固定されてしまうため5秒の時点で画面から消えるようにする */
            50% {
                margin-left: -100%;
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(-200%)
            }
        }
    </style>
</head>
<body>
    <div id="placeholder"></div>
    <!-- /socket.io/socket.io.js は自動で生成されるので作成する必要はない -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>
        let socket = io();

        let itemHeight = 100;
        // コメント用の行の数
        let slot = [0, 0, 0, 0, 0, 0, 0, 0];

        // 接続時の処理
        socket.on('connect', () => {
            console.log("socket.ioに接続しました");
        });

        // サーバーからのメッセージ拡散に対する処理
        socket.on('spread message', (strMessage) => {
            console.log(`spread message:${strMessage}`);

            // OPENRECのコメントがスタンプの場合は処理しない
            if(strMessage.length == 0) return;

            // 流れるコメントの作成
            createMoveComment(strMessage);
        });

        // コメントを削除する関数の実行感覚
        setInterval(updateTimeLimit, 2300);


        function createMoveComment(comment) {
            // slot配列を0に戻す
            for (let c = 0; c < slot.length; c++) slot[c] = 0;

            // 繰り返して指定した関数を実行する
            $('#placeholder').children().each((index, comment) => {
                let y = parseFloat($(comment).css("top"));
                let x = parseFloat($(comment).css("left"));

                // y/itemHeight を四捨五入する
                let idx = Math.round(y/itemHeight);
                // コメントの右側を
                let right = $(comment).data("width") + x;

                // ここで配列slotの1部分が変わる
                slot[idx] = Math.max(slot[idx], right);
            });

            // 最初は最大値になるようにしている
            let minRight = Number.MAX_VALUE;
            let minSlot = 0;

            for (let c = 0; c < slot.length; c++) {
                if(slot[c] < minRight) {
                    minRight = slot[c];
                    minSlot = c;
                }
            }

            let wrapper = $('<div data-timelimit="20">');
            let message = $("<span>");
            
            // wrapperにID:chatを付加
            wrapper.attr("class", "chat");
            message.attr("class", "comment");

            //message_inner.text(comment);
            message.text(comment);
            wrapper.append(message);

            // CSSを付与
            wrapper.css("top", itemHeight * minSlot);
            //wrapper.css("left", Math.max($(window).innerWidth(), minRight));

            // placeholderにwrapperを追加
            $('#placeholder').append(wrapper);
            $(wrapper).data("width", wrapper.width());
        }

        function updateTimeLimit() {
            // placeholder要素内の全ての子要素に対して以下の操作を行う
            $(placeholder).children().each((index, i) => {
                let l = $(i).attr("data-timelimit");
                console.log(l);
                $(i).attr("data-timelimit", `${l-10}`);
                if(l <= 0) $(i).remove();
            });
        }
    </script>
</body>
</html>