<!DOCTYPE html>
<html>
<head>
    <style type=text/css>
    * {
            margin: 0px;
            padding: 0px;
        }
        body {
            background-color: rgb(0, 255, 0);
            position: relative;
            overflow: hidden;
            /* これによってコメントが長くても折り返さないようになる */
            white-space: nowrap;
            
        }

        .chat {
            color: rgb(255, 255, 255);
            font-weight: 900;
            font-size: 10vh;
            font-family: "Segoe UI Emoji", "MS P ゴシック";
            position: absolute;
            will-change: left, transform;
            animation: commentMove 5s linear;

            /* これをつけることによって移動が終わっても画面から消えたところで固定される */
            animation-fill-mode: forwards;

            text-shadow: rgb(0, 0, 0) 4px 0px 0px, rgb(0, 0, 0) 3.87565px 0.989616px 0px, rgb(0, 0, 0) 3.51033px 1.9177px 0px, rgb(0, 0, 0) 2.92676px 2.72656px 0px, rgb(0, 0, 0) 2.16121px 3.36588px 0px, rgb(0, 0, 0) 1.26129px 3.79594px 0px, rgb(0, 0, 0) 0.282949px 3.98998px 0px, rgb(0, 0, 0) -0.712984px 3.93594px 0px, rgb(0, 0, 0) -1.66459px 3.63719px 0px, rgb(0, 0, 0) -2.51269px 3.11229px 0px, rgb(0, 0, 0) -3.20457px 2.39389px 0px, rgb(0, 0, 0) -3.69721px 1.52664px 0px, rgb(0, 0, 0) -3.95997px 0.56448px 0px, rgb(0, 0, 0) -3.97652px -0.432781px 0px, rgb(0, 0, 0) -3.74583px -1.40313px 0px, rgb(0, 0, 0) -3.28224px -2.28625px 0px, rgb(0, 0, 0) -2.61457px -3.02721px 0px, rgb(0, 0, 0) -1.78435px -3.57996px 0px, rgb(0, 0, 0) -0.843183px -3.91012px 0px, rgb(0, 0, 0) 0.150409px -3.99717px 0px, rgb(0, 0, 0) 1.13465px -3.8357px 0px, rgb(0, 0, 0) 2.04834px -3.43574px 0px, rgb(0, 0, 0) 2.83468px -2.82216px 0px, rgb(0, 0, 0) 3.44477px -2.03312px 0px, rgb(0, 0, 0) 3.84068px -1.11766px 0px, rgb(0, 0, 0) 3.9978px -0.132717px 0px;
        }

        @keyframes commentMove {
            0% {
                left: 100%;
                transform: translateX(0%);
            }
            100% {
                left: 0%;
                transform: translateX(-100%);
            }
        }
    </style>
</head>
<body>
    <div id="placeholder"></div>
    <!-- /socket.io/socket.io.js は自動で生成されるので作成する必要はない -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>
        let socket = io();

        // ブラウザに何行のコメントを表示するか
        const windowDevided = 11;
        // コメント1行の高さを取得
        let commentHeight = Math.round(document.documentElement.clientHeight/windowDevided);
        // コメントの表示時間(単位：ms)
        const commentDisplayTime = 5000;
        // 各行のコメントが消える時間の管理をする配列を作成
        let rowCommentDeleteTime = Array(windowDevided);
        rowCommentDeleteTime.fill(0);
        // 各行を流れるコメントの長さの配列
        let rowCommentLength = Array(windowDevided);
        rowCommentLength.fill(100000);

        // 接続時の処理
        socket.on('connect', () => {
            console.log("socket.ioに接続しました");
        });

        // サーバーからのメッセージ拡散に対する処理
        socket.on('spread message', (strMessage) => {
            // OPENRECのコメントがスタンプの場合は処理しない
            if(strMessage.length == 0) return;

            // 流れるコメントの作成
            createMoveComment(strMessage);
        });

        setInterval(commentDelete, commentDisplayTime);

        // const createMoveComment = (strMessage) => {
        //     const wrapper = $("<div>");
        //     wrapper.attr("class", "chat");
        //     wrapper.append(strMessage);
        //     $(wrapper).data("chat", wrapper.width());
        //     $("#placeholder").append(wrapper);
        // }

        function createMoveComment(commentMessage) {
            // コメントが削除される時間と何行目に流すかと一番早く消える場所
            let comment = {
                deleteTime: Date.now()+commentDisplayTime,
                flowRow: 0,
                maxDisappearTime: 0,
                length: commentMessage.length
            };

            // コメントをどこに配置出来るか？
            for (let i = 0; i < rowCommentDeleteTime.length; i++) {
                // 行からコメントが削除されているかの確認用変数
                let compareDeleteTime = comment.deleteTime - rowCommentDeleteTime[i];
                //console.log(compareDeleteTime);
                if (comment.length < rowCommentLength || compareDeleteTime >= commentDisplayTime) {
                    // コメントを流す処理をする
                    rowCommentDeleteTime[i] = comment.deleteTime;
                    rowCommentLength[i] = comment.length;
                    comment.flowRow = i;
                    break;
                    // コメントをそこに流さない場合、今あるコメントが一番早くコメントが流れ終わる場所を探す
                } else if (comment.maxDisappearTime < compareDeleteTime) {
                    //console.log(`compare:${i+1} ${compareDeleteTime}`)
                    comment.maxDisappearTime = compareDeleteTime;
                    comment.flowRow = i;
                    continue;
                    // 最後まで条件を満たす行がなかった時、一番早くコメントが流れ終わっている行に流す
                } else if (i == rowCommentDeleteTime.length - 1) {
                    rowCommentDeleteTime[comment.flowRow] = comment.deleteTime;
                    rowCommentLength[comment.flowRow] = comment.length;
                    console.log(`${i+1}回目のループ：${comment.flowRow}に流す`)
                    break;
                }
            }
            
            // コメントのDOMの作成時刻を持たせる
            const wrapper = $(`<div data-timelimit=${comment.deleteTime}>`);      
            wrapper.attr("class", "chat");
            // CSSを付与
            wrapper.css("top", commentHeight * comment.flowRow);
            // wrapperにID:chatを付加
            wrapper.append(commentMessage);
            
                
            // placeholderにwrapperを追加
            //console.log(`コメントを流します: ${comment.flowRow+1}行目`)
                
                
            //setTimeout(function() {wrapper.remove();}, commentDisplayTime);
            $('#placeholder').append(wrapper);
        }

        function commentDelete() {
            let updateTime = Date.now()
            // placeholder要素内の全ての子要素に対して以下の操作を行う
            $(placeholder).children().each((index, i) => {
                if(updateTime - $(i).attr("data-timelimit") >= 0) $(i).remove();
            });
            //setTimeout(updateTimeLimit, intervalTime);
        }
    </script>
</body>
</html>

<!-- 
    コメントの幅
    文字列が消えるまでのコマ数
    左端からの距離
    １コマあたりの移動距離：
 -->